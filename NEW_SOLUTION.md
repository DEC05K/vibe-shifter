# 新しい解決策：ランタイムURL動的取得

## 問題の本質

Shopify Admin側のサーバーが古いURLを返しているため、以下の方法では解決しません：
- `shopify.app.toml`の更新
- Partnersダッシュボードの設定更新
- ブラウザのキャッシュクリア
- アプリの再インストール

## 新しいアプローチ

### 解決策1: ランタイムで最新URLを動的に取得（実装済み）

アプリの起動時に、`.shopify/dev-bundle/manifest.json`から最新のURLを読み取り、`shopifyApp`の設定で使用します。

**実装内容:**
1. `app/utils/get-app-url.server.ts`: 最新URLを取得するユーティリティ
2. `app/shopify.server.ts`: ランタイムで最新URLを使用するように変更

**メリット:**
- `shopify.app.toml`やPartnersダッシュボードの設定に依存しない
- `shopify app dev`が起動するたびに、最新URLが自動的に使用される
- 環境変数よりも優先度が高い

### 解決策2: リクエストインターセプト（実装済み）

古いURLからのリクエストを検出し、最新URLにリダイレクトします。

**実装内容:**
1. `app/utils/url-redirect.server.ts`: URLリダイレクトハンドラー
2. `app/entry.server.tsx`: すべてのリクエストをチェックしてリダイレクト

**メリット:**
- 古いURLにアクセスしても、自動的に最新URLにリダイレクトされる
- ユーザーは何も意識する必要がない

## 実装の確認

実装が完了したら、以下を確認してください：

1. **ビルドが成功するか確認**
   ```bash
   npm run build
   ```

2. **アプリを再起動**
   ```bash
   shopify app dev
   ```

3. **動作確認**
   - アプリにアクセスして、正常に表示されることを確認
   - 古いURLにアクセスしても、最新URLにリダイレクトされることを確認

## 次のステップ

1. ビルドエラーがないか確認
2. アプリを再起動
3. 動作確認

問題があれば、エラーメッセージを共有してください。

